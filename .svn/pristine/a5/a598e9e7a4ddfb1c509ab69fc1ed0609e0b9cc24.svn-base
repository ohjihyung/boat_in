<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>  
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />


<div class="content-page">
	<div class="content">
	
	    <!-- Start Content-->
		<div class="container-fluid">
		
			<!-- start page title -->
			<div class="row0">
			    <div class="col-12">
			        <div class="page-title-box">
			            <h4 class="page-title">My DataRoom</h4>
			            <div>
			                <ol class="breadcrumb m-0">
			                    <li class="breadcrumb-item"><a href="javascript: void(0);">BOAT-IN</a></li>
			                    <li class="breadcrumb-item active">MyDataRoom</li>
			                </ol>
			            </div>
			        </div>
			    </div>
			</div>     
			<!-- end page title --> 
			
			<div class="row1">
			    <div class="col-12">
			        <div class="card">
			            <div class="card-body">
			                
							<!-- Left sidebar -->
							<div class="inbox-leftbar text font-15 fw-bold">
								<!-- ì—¬ê¸°ì— íŠ¸ë¦¬ ìƒì„± -->
								<ul style="margin-top: 0px; padding: 0px">
									<li class="list-group-item list-group-item-primary" style="margin-bottom: 10px; text-align: center;">
										<a href="javascript:void(0);" onclick="getRepoData()" style="display: block;">ë‚´ ë³´ê´€í•¨ğŸ‘‰</a>
									</li>
								</ul>
								<hr/>
								<ul style="margin: 0px; padding: 0px">
									<li class="list-group-item list-group-item-primary" style="margin-bottom: 10px; text-align: center;">
										<a href="javascript:void(0);" style="display: block;">ë‚´ í”„ë¡œì íŠ¸ğŸ‘‰</a>
									</li>
								</ul>
								<div class="text font-14" id="projectTree"></div>
							</div>
							<!-- End Left sidebar -->
			
							<!-- start inbox-rightbar-->
							<div class="inbox-rightbar" id="rightBar">
							                        
								<!-- ë‚´ ë³´ê´€í•¨ -->
								<div class="col-xl-12">
									<ul class="nav nav-tabs nav-bordered nav-justified">
<!-- 									<ul class="nav nav-tabs nav-bordered"> -->
										<li class="nav-item" style="width: 250px; text-align: center;">
											<a href="#download-b1" data-bs-toggle="tab" aria-expanded="true" class="nav-link active" style="font-size: 15px; font-weight: bold;">ë‹´ì€ íŒŒì¼</a>
										</li>
										<li class="nav-item" style="width: 250px; text-align: center;">
											<a href="#upload-b1" data-bs-toggle="tab" aria-expanded="false" class="nav-link" style="font-size: 15px; font-weight: bold;">ì˜¬ë¦° íŒŒì¼</a>
										</li>
									</ul>
								   <div class="tab-content">
								      <div class="tab-pane" id="download-b1"></div>
								      <div class="tab-pane show active" id="upload-b1"></div>
								   </div>
								</div>
							
							<!-- íŒŒì¼ ì¶œë ¥ -->
							<!--                                               <div class="row2"> -->
							<!--                                     <div class="col-md-12"> -->
							<!--                                                <div class="card"> -->
							<!--                                                    <div class="card-header" style="background-color: #D6E8F6"> -->
							<!--                                                        <h4 class="card-title mb-0 fw-bold" style="color: #1F547F" id="cateName">ì¹´í…Œê³ ë§</h4> -->
							<!--                                                        <p class="text-muted mb-0 fw-bold" id="twName">ìƒìœ„ì‘ì—…</p> -->
							<!--                                                    </div> -->
							<!--                                                    <div class="card-body" id="gallary"> -->
							<!--                                                           ê°¤ëŸ¬ë¦¬ -->
							<!--                                                    </div> -->
							<!--                                                </div> -->
							
							<!--                                                  <div class="card text-center"> -->
							<!--                                                      <div class="card-header" style="padding-top: 5px"> -->
							<!--                                                         <h4 class="page-title fw-bold">ì¹´í…Œê³ ë¦¬ëª…</h4> -->
							<!--                                                          <ul class="nav nav-tabs card-header-tabs" id="navBar"> -->
							<!--                                                              <li class="nav-item"> -->
							<!--                                                                  <a class="nav-link" href="ì—¬ë”°ê°€ìƒìœ„ì‘ì—…í´ë”ê²½ë¡œë„£ì–´ë¼~">ìƒìœ„ì‘ì—…ëª…</a> -->
							<!--                                                              </li> -->
							<!--                                                          </ul> -->
							<!--                                                      </div> -->
							<!--                                                      <div class="card-body"> -->
							<!--                                                         <div class="listArea"> -->
							
							<!--                                                 <div class="row2"> -->
							<!--                                                    <div class="m-2"></div> -->
							<!--                                                    <div id="gallary2" class="flex-container" style="display: flex; flex-wrap: wrap;"> -->
							<!--                                                    </div> -->
							<!--                                                 </div> -->
							
							<!--                                                        </div> -->
							<!--                                                      </div> -->
							<!--                                                  </div> -->
							<!--                                              </div> -->
							<!--                                          </div> -->
							     
							</div> <!-- end inbox-rightbar-->
						</div> <!-- end CardBody -->
					</div> <!-- end Card -->
				</div> <!-- end col -->
			</div> <!-- end row -->
		</div> <!-- end container -->
	</div> <!-- content -->
</div>


<script>

$(document).ready(function() {
   getProData();
   getRepoData();
});


/**
 * SSY 'ë‚´ í”„ë¡œì íŠ¸' í´ë¦­ ì‹œ íŠ¸ë¦¬ ìƒì„± ë° í•´ë‹¹ íŒŒì¼ ì¶œë ¥í•˜ê¸°
 */
function getProData() {
   
   // ì ‘ì†í•œ ì•„ì´ë”” ê°€ì ¸ì˜¤ê¸°(MEMBER_ID)
   let memberId = localStorage.getItem('id');
   console.log("id : ", memberId);
   
   // =============================================================================================
   
   // ë‚´ í”„ë¡œì íŠ¸ íŒŒì¼ íŠ¸ë¦¬
   $.ajax({   
        type : 'POST',
        url : '/data/myProDataRoom',
        data : { memberId : memberId },
        dataType : 'json',
        success : function(data) {
           
           console.log("myDataRoom-í”„ë¡œì íŠ¸.jsp - success-data : ", data);
             let arr = new Array();
             
           $.each(data, function(i, item){
              
                    arr[i] = {
                                depth : item.DEPTH,
                                id : item.FILE_ID,
                                parent : item.PARENT_ID,
                                text : item.FILE_NAME
                              }
           
           });
           console.log("arr : ", arr)
           
           // í”„ë¡œì íŠ¸(depth == 0)ë§Œ ë½‘ì•„ì„œ ë°°ì—´ ë§Œë“¤ê¸°
         let fileArr = arr.filter(function(project){
           return project.depth == 0;
         })
             console.log("fileArr : ", fileArr);
           
           // projectTree ìƒì„±
           $.noConflict()
           $('#projectTree').jstree({
              "plugins" : ['wholerow', 'types', 'json_data'],
              "core" : {
                  "data" : fileArr    // ë°ì´í„° ì—°ê²° 
              },
           })
           .bind('loaded.jstree', function(e,data){   // íŠ¸ë¦¬ ë¡œë”© ì™„ë£Œ ì´ë²¤íŠ¸ 
//               alert("ë¡œë”©ì™„ë£Œ!");
              
//               $("#tree").jstree("open_all");   // ì „ì²´ ì˜¤í”ˆ... ì˜¤ìš° ë˜ë„¤...?
      
           })
           .bind('select_node.jstree',function(e,data){   // ë…¸ë“œ ì„ íƒ ì´ë²¤íŠ¸
              console.log("í”„ë¡œì íŠ¸ ë…¸ë“œì„ íƒì´ë²¤íŠ¸ - data : ", data);
            
            // ë…¸ë“œ ì´ˆê¸°í™”
            $("#rightBar").empty();
           
              // ë…¸ë“œ í´ë¦­ ì‹œ í”„ë¡œì íŠ¸ì— í•´ë‹¹í•˜ëŠ” íŒŒì¼ë“¤ ê°€ì ¸ì˜¤ê¸°
              let name = data.instance.get_node(data.selected).original.text;        // í”„ë¡œì íŠ¸ ì´ë¦„
             let depth = data.instance.get_node(data.selected).original.depth;      // ê³„ì¸µ
             let parentId = data.instance.get_node(data.selected).original.parent;   // ë¶€ëª¨ ì•„ì´ë””
              let proNo = data.instance.get_node(data.selected).original.id;         // í”„ë¡œì íŠ¸ ë²ˆí˜¸
              console.log("name : ", name);
              console.log("depth : ", depth);
              console.log("parentId : ", parentId);
              console.log("proNo : ", proNo);
            
              $.ajax({
                 type : 'POST',
               url : '/data/myProGallary',
               data : {
                     name : name,
                     depth : depth,
                     parentId : parentId,
                     proNo : proNo
               },
               dataType : 'json',
               success : function(data) {
                  console.log("data - í”„ë¡œì íŠ¸ ê°¤ëŸ¬ë¦¬~ : ", data);
                  
                  $.each(data, function(i, item) {
                     
//                      console.log("i : ", i);
                     
                     let cnt = i;
//                      console.log("cnt : ", cnt);
                             let parent = document.querySelector("#rightBar");
                             
                     let cateName = item.uuid;
                     let twName = item.fileSize;
                     let filePath = item.filePath;
//                      console.log("memberId : ", memberId);
//                      console.log("filePath : ", filePath);
                     // ojh ê²½ë¡œì—ì„œ \ë¥¼ \\ë¡œ ë°”ê¾¸ê¸°
                     filePath = filePath.replaceAll("\\", "\\\\");
                     
                     let container = null;
                     let gallary = "";
                     let childElement = null;
                     let txt = "";
                     
                     txt += `<div class="card m-2" style="flex: 1 1 20%">`;
                     txt += `<a style="text-align:center;font-size:13px;padding:0px;" href="` + item.filePath + `" download = "` + item.fileRealName + `">`;
                     txt += `<img style="width: 220px; height: 200px" class="card-img-top embed-responsive-item" src="` + item.fileUploader + `" alt="Card image cap"/>`;
                     txt += `<p style="text-align: center; margin-top:15px; margin-bottom: 15px">`
                     		 + item.fileName + 
                     		`&nbsp;&nbsp;<a href="javascript:void(0)" onclick="putMyRepo(memberId,'\${filePath}','\${item.fileRealName}')"><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 25 25" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-plus icon-dual"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg></a></p>`;
                     txt += `</a>`;
                     txt += `</div>`;


                     let row = document.createElement("div");
                     row.className = "row2 " + i;
                     row.id = "row2" + i;
                     parent.append(row);
                     
                     let col = document.createElement("div");
                     col.className = "col-md-12 " + i;
                     row.append(col);
                     
                     let card = document.createElement("div");
                     card.className = "card " + i;
                     card.id = "card";
                     col.append(card);
                     
                     let cardHeader = document.createElement("div");
                     cardHeader.className = "card-header " + i;
                     cardHeader.style.cssText = "background-color: #D6E8F6";
                     card.append(cardHeader);
                     
                     let cardTitle = document.createElement("h4");
                     cardTitle.className = "card-title mb-0 fw-bold " + i;
                     cardTitle.style.cssText = "color: #1F547F";
                     cardTitle.id = "twName";
                     cardTitle.innerText = twName;
                     cardHeader.append(cardTitle);
                     
                     let p = document.createElement("p");
                     p.className = "text-muted mb-0 fw-bold " + i;
                     p.id = "cateName";
                     p.innerText = cateName;
                     cardHeader.append(p);
                     
                     let cardBody = document.createElement("div");
                     cardBody.className = "card-body " + i;
                     cardBody.id = twName;
                     cardBody.style = "display: flex; flex-wrap: wrap";
                     card.append(cardBody);
//                      console.log("cardBody : ", cardBody.style);
                     
                     // ì¹´í…Œê³ ë¦¬ ì¤‘ë³µ ì²˜ë¦¬
                     if(i > 0) {
                        
                                let curCateName = data[i-1].uuid;
                                let curTwName = data[i-1].fileSize;
//                                 console.log("curCateName : ", curCateName);
//                                 console.log("curTwName : ", curTwName);

                        if(curTwName == twName) {
                           // ë…¸ë“œ ì„ íƒ
                           const parentRow = document.getElementById('row2' + i);
                           // ë³¸ì¸ ë…¸ë“œ ì‚­ì œ
                           parentRow.remove();
                        }      
                     }
                     
                     // ì‚¬ì§„ ë„ìš°ê¸°
                     gallary = document.getElementById(twName);
//                      console.log("gal : ", gallary);
                     
                     childElement = document.createElement("div");
                     childElement.className = "childElement" + i;
                     childElement.id = item.fileSize;
//                      console.log("childElement : ", childElement);
//                      console.log("childElement" + i);
                     
//                      console.log("childElement.id : ", childElement.id);
                     
                     // ìƒìœ„ì‘ì—…ë³„ë¡œ ì‚¬ì§„ ë¶„ë¥˜í•˜ê¸°
                     if(childElement.id.trim() == gallary.id.trim()) {
                        gallary.append(childElement);
                        document.querySelector(".childElement" + i).innerHTML = txt;
                     }
//                      console.log("row : ", row);
            
                  });   // end of each

               },
               error : function() {
                  alert("error - í”„ë¡œì íŠ¸ ë…¸ë“œì„ íƒì´ë²¤íŠ¸");
               }
            });
            
            
           });   // end of projectTree
           
        }, // end of success
        error : function() {
           alert("error - í”„ë¡œì íŠ¸ íŠ¸ë¦¬ ìƒì„±");
        } // end of error
    });   // end of ajax

} //end of getProData


/**
 * SSY íŒŒì¼ ë³´ê´€í•˜ê¸°
 */
function putMyRepo(a,b,c) {

   let data = {
               "myId" : a,
               "downPath" : b,
               "fileName" : c
            }
   let xhr = new XMLHttpRequest();
   xhr.open("POST","/data/putMyRepo",true);
   xhr.onreadystatechange = function() {
      if(xhr.readyState == 4 && xhr.status == 200){
         console.log(xhr.responseText);
      }
   }
   xhr.setRequestHeader("Content-Type", "application/json;charset=utf-8");
   xhr.send(JSON.stringify(data));
}


/**
 * SSY 'ë‚´ ë³´ê´€í•¨' í´ë¦­ ì‹œ í•´ë‹¹ íŒŒì¼ ì¶œë ¥í•˜ê¸°
 */
function getRepoData() {
   
   // ì ‘ì†í•œ ì•„ì´ë”” ê°€ì ¸ì˜¤ê¸°(MEMBER_ID)
   let memberId = localStorage.getItem('id');
   console.log("getRepoData - id : ", memberId);
   
   $.ajax({
      type : 'POST',
      url : '/data/myRepoGallary',
      data : {
         memberId : memberId
      },
      dataType : 'json',
      success : function(data) {
         console.log("getRepoData - data : ", data);
         
		// rightBar ì´ˆê¸°í™”
		$("#rightBar").empty();
		  
		let parent = document.querySelector("#rightBar");
		
		let col = document.createElement("div");
		col.className = "col-xl-12";
		parent.append(col);
		
		let ul = document.createElement("ul");
// 		ul.className = "nav nav-tabs nav-bordered";
		ul.className = "nav nav-tabs nav-bordered nav-justified";
		col.append(ul);
		
		let liDown = document.createElement("li");
		liDown.className = "nav-item";
		liDown.style.cssText = "width: 250px; text-align: center;";
		ul.append(liDown);
		
		let aDown = document.createElement("a");
		aDown.className = "nav-link active";
		aDown.style.cssText = "font-size: 15px; font-weight: bold;";
		aDown.setAttribute("href","#download-b2");
// 		aDown.setAttribute("href","#download-b1");
		aDown.setAttribute("data-bs-toggle","tab");
		aDown.setAttribute("aria-expanded","true");
		aDown.innerText = "ë‹´ì€ íŒŒì¼";
		liDown.append(aDown);
		
		let liUp = document.createElement("li");
		liUp.className = "nav-item";
		liUp.style.cssText = "width: 250px; text-align: center;";
		ul.append(liUp);
		
		let aUp = document.createElement("a");
		aUp.className = "nav-link";
		aUp.style.cssText = "font-size: 15px; font-weight: bold;";
		aUp.setAttribute("href","#upload-b2");
// 		aUp.setAttribute("href","#upload-b1");
		aUp.setAttribute("data-bs-toggle","tab");
		aUp.setAttribute("aria-expanded","false");
		aUp.innerText = "ì˜¬ë¦° íŒŒì¼";
		liUp.append(aUp);
		
		let content = document.createElement("div");
		content.className = "tab-content";
		col.append(content);
		
		let paneDown = document.createElement("div");
		paneDown.className = "tab-pane show active";
		paneDown.id = "download-b2";
// 		paneDown.id = "download-b1";
		paneDown.style.cssText = "display: flex; flex-wrap: wrap;";
		content.append(paneDown);
		
		let paneUp = document.createElement("div");
		paneUp.className = "tab-pane";
		paneUp.id = "upload-b2";
// 		paneUp.id = "upload-b1";
		paneUp.style.cssText = "display: flex; flex-wrap: wrap;";
		content.append(paneUp);
         
         // íŒŒì¼ ì›ë³¸ ê²½ë¡œ, íŒŒì¼ ì›ë³¸ëª…, ë””í´íŠ¸ ì´ë¯¸ì§€
         $.each(data, function(i, item) {
            let downloadTab = document.querySelector("#download-b1");   // ë‹´ì€ íŒŒì¼ íƒ­
//             let uploadTab = document.querySelector("#upload-b1");      // ì˜¬ë¦° íŒŒì¼ íƒ­
            
            let childElement = null;
            let txt = ``;
            
            txt += `<div class="card m-2" style="flex: 1 1 20%">`;
            txt += `<a style="text-align: center; font-size: 13px; padding: 0px;" href="` + item.filePath + `" download = "` + item.fileRealName + `">`;
            txt += `<img style="width: 220px; height: 200px" class="card-img-top embed-responsive-item" src="` + item.filePath + `" alt="Card image cap"/>`;
            txt += `<p style="text-align: center; margin-top: 15px">` + item.fileRealName + `</p>`;
            txt += `</a>`;
            txt += `</div>`;
            
//             txt += `<div class="card m-2" style="flex: 1 1 20%">`;
//             txt += `<a style="text-align:center;font-size:13px;padding:0px;" href="` + item.filePath + `" download = "` + item.fileRealName + `">`;
//             txt += `<img style="width: 220px; height: 200px" class="card-img-top embed-responsive-item" src="` + item.fileUploader + `" alt="Card image cap"/>`;
//             txt += `<p style="text-align: center; margin-top:15px; margin-bottom: 15px">`
//             		 + item.fileName + 
//             		`&nbsp;&nbsp;<a href="javascript:void(0)" onclick="delMyRepo(memberId,'\${filePath}','\${item.fileRealName}')"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder-minus icon-dual"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="9" y1="14" x2="15" y2="14"></line></svg></a></p>`;
//             txt += `</a>`;
//             txt += `</div>`;
            
            
            childElement = document.createElement("div");
            childElement.className = "childElement" + i;
            console.log("childElement" + i);
            paneDown.append(childElement);
            
            document.querySelector(".childElement" + i).innerHTML = txt;
         });   // end of each
      
      },
      error : function() {
         console.log("getRepoData - error");
      }   // end of error

   });   // end of ajax
   
   
}   // end of getRepoData
         

</script>

